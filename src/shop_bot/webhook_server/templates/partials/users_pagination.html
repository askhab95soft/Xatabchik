{% set cp = current_page or 1 %}
{% set tp = total_pages or 1 %}
{% set query = q or '' %}
{% set per = per_page or 25 %}
{% set sort_val = sort or '' %}

{# "Вперед" (next) #}
<li class="page-item {% if cp >= tp %}disabled{% endif %}">
  <a class="page-link" href="{{ url_for('users_page', page=(cp+1 if cp<tp else tp), q=query, per_page=per, sort=sort_val) }}" aria-label="Next">Вперед</a>
</li>

{% set edges = 3 %}
{% set around = 1 %}
{% set ns = namespace(last=0) %}
{% for p in range(1, tp + 1) %}
  {% set show = (tp <= (edges*2 + around*2 + 3)) or (p <= edges) or (p > tp - edges) or (p >= cp - around and p <= cp + around) %}
  {% if show %}
    {% if ns.last and (p - ns.last) > 1 %}
      <li class="page-item disabled"><span class="page-link">…</span></li>
    {% endif %}
    <li class="page-item {% if p == cp %}active{% endif %}">
      <a class="page-link" href="{{ url_for('users_page', page=p, q=query, per_page=per, sort=sort_val) }}">{{ p }}</a>
    </li>
    {% set ns.last = p %}
  {% endif %}
{% endfor %}

{# "Назад" (prev) #}
<li class="page-item {% if cp <= 1 %}disabled{% endif %}">
  <a class="page-link" href="{{ url_for('users_page', page=(cp-1 if cp>1 else 1), q=query, per_page=per, sort=sort_val) }}" aria-label="Previous">Назад</a>
</li>
